{% extends "sqlshare_web/base.html" %}

{% block title %}SQLSHARE: Dataset Detail{% endblock %}

{% load staticfiles %}

{% block content %}

<h2 class="sql-detail-title">{{ dataset.name }}</h2>

<div style="position:relative;">
    
    {% if not request.is_mobile %}<span class="sql-dataset-owner"><i class="fa fa-user"></i> {{ dataset.owner }}</span>{% endif %}
    <span class="sql-dataset-modified"><i class="fa fa-calendar"></i> {{ dataset.date_modified }}</span>
    
    <div class="form-group sql-dataset-desc" style="margin: 15px 0;">
        <label for="query_sql" class="sr-only">Description:</label>    
        <textarea class="form-control" id="dataset_description" rows="4">{{ dataset.description }}</textarea>
    </div>
    
    <div class="sql-dataset-actions">
        {% if dataset.owner == user.username %}
        <button type="button" class="btn btn-default btn-sm" id="make_dataset_private" {% if not dataset.is_public %}style="display:none;"{% endif %}><i class="fa fa-eye"></i> <span>PUBLIC</span></button>
        <button type="button" class="btn btn-default btn-sm" id="make_dataset_public" {% if dataset.is_public %}style="display:none;"{% endif %}><i class="fa fa-eye-slash"></i> <span>PRIVATE</span></button>
        
        <button type="button" class="btn btn-default btn-sm" id="" data-toggle="modal" data-target="#share_modal"><i class="fa fa-share"></i> <span>SHARE</span></button>
        <button type="button" class="btn btn-danger btn-sm" id="" data-toggle="modal" data-target="#delete_modal"><i class="fa fa-trash"></i> <span>DELETE</span></button>
        {% endif %}
    </div>

</div>
    
<hr>

<div  style="position: relative; margin-bottom:3em;">
    {% csrf_token %}
    
    <h3>SQL Query</h3>
    
    <div class="form-group">
        <label for="query_sql" class="sr-only">SQL Query:</label>    
        <textarea id="query_sql" name='dataset_sql' class="well" style="background:#fff;">{{ dataset.sql_code }}</textarea>
    </div>
    
    <div style="margin-bottom:1em;">
        <button type="button" class="btn btn-primary" id="run_query">RUN QUERY</button>
        <button type="button" class="btn btn-default" id="update_dataset_sql" style="display: none;">UPDATE DATASET</button>
    </div>
    
    <div class="sql-dataset-actions">
        <form action="/new/" method="POST" id="new_dataset_from_query_form">
        {% csrf_token %}
        <input type="hidden" name="sql" value="" id="new_query_sql"/>
        <input type="hidden" name="show_initial" value="1" />
        <button type="button" class="btn btn-default btn-sm" id="new_dataset_from_query"><i class="fa fa-database"></i> <span style="display:inline-block !important;">NEW DATASET FROM QUERY</span></button>
        </form>
        
        
    </div>
</div> 

    
<div id="query_preview_panel" style="display: none;">
    <h3>Dataset Preview</h3>

    <div id="query_running_panel" class="well" style="display: none;">
        <p class="text-muted"><i class="fa fa-circle-o-notch fa-spin"></i> Running query...</p>
    </div>
    <div id="query_results_panel" class="well" style="display: none;"></div>

</div>
    

<div style="position:relative;" id="original_results_panel">
    
    <h3>Dataset Preview</h3>
    
    {% include "sqlshare_web/sample_data_preview.html" %}
    
</div>

<!-- share dataset modal -->
<div class="modal fade" id="share_modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div id="sharing-modal-loading">
          Loading...
      </div>
      <div id="sharing-modal-display">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="myModalLabel">Share Dataset</h3>
      </div>
      <div class="modal-body">
        <p class="text-muted">Enter UW NetID of users you want to share with!</p>
        
        <div class="form-group" id="user-autocomplete-container">
            <label for="exampleInputEmail1">Email address</label>
            <input type="text" class="form-control" id="exampleInputEmail1" placeholder="Enter email">
        </div>

        <div>
            Users:
            <div id="dataset_access_list">
            </div>
        </div>
  
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save_permissions_button">Save changes</button>
      </div>
      </div>
    </div>
  </div>
</div>  

<!-- delete dataset modal -->
<div class="modal fade" id="delete_modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="myModalLabel">Delete Dataset</h3>
      </div>
      <div class="modal-body">
        <p class="text-danger">Are you sure you want to delete {{ dataset.name }}?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="delete_dataset">Delete</button>
      </div>
    </div>
  </div>
</div>  
    
<script>
    document.body.onload = function() { prep_details_page(); };
</script>

<script id="user-access-item" type="text/x-handlebars-template">
{% verbatim %}
<div>
    <label><input type="checkbox" checked="checked" value="{{username}}" name="dataset_account"><span>{{ username }}</span></label>
</div>
{% endverbatim %}
</script>

{% endblock %}
